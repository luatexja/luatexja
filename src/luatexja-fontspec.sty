%
% luatexja-fontspec.sty
%

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{luatexja-fontspec}[2011/08/17 v0.1]

\RequirePackage{luatexja,fontspec}

\ExplSyntaxOn

\define@key[zf]{options}{JFM}{
  \fontspec_update_featstr:n {jfm=#1}
}

\cs_new:Nn \ltj_fontspec_select:nn {
  \group_begin:
  \tl_set:Nn \zf@enc {JY3}
  \fontspec_select:nn{JFM=ujis,#1}{#2}
  \cs_undefine:c{g_fontspec_ \zf@family _prop}
  \fontspec_select:nn{JFM=ujis,#1}{#2}
  \group_end:
  \cs_undefine:c{g_fontspec_ \zf@family _prop}  
}

\cs_new:Nn \ltj_fontspec_set_newjfamily:Nnn {
  \ltj_fontspec_select:nn{#2}{#3}
  \tl_set_eq:NN #1 \zf@family
}

\DeclareDocumentCommand \jfontspec { O{} m } {
  \ltj_fontspec_set_newjfamily:Nnn \k@family {#1}{#2}
  \selectfont
  \ignorespaces
}

\DeclareDocumentCommand \setmainjfont { O{} m } {
  \ltj_fontspec_set_newjfamily:Nnn \mcdefault {#1}{#2}
  \normalfont
}

\DeclareDocumentCommand \setsansjfont { O{} m } {
  \ltj_fontspec_set_newjfamily:Nnn \gtdefault {#1}{#2}
  \normalfont
}

\DeclareRobustCommand\jfontfamily[1]{\edef\k@family{#1}}

\DeclareDocumentCommand \newjfontfamily { m O{} m } {
  \ltj_fontspec_select:nn{#2}{#3}
  \use:x {
    \exp_not:N \DeclareRobustCommand \exp_not:N #1 {
      \exp_not:N \jfontfamily {\zf@family} \exp_not:N \selectfont
    }
  }
}
