%
% lltjp-listings.sty
%
% Modified from jlisting.sty (by Thor) for LuaTeX-ja. 
%

\NeedsTeXFormat{LaTeX2e}
\def\filedate{2012/01/11}
\def\fileversion{0.4}
\ProvidesPackage{lltjp-listings}[\filedate\space\fileversion]
\RequirePackage{listings,luatexbase-cctb}

% catcode 対策
\newluatexcatcodetable\CatcodeTableLTJlistings
\setluatexcatcodetable\CatcodeTableLTJlistings{
  \luatexcatcodetable\CatcodeTableLaTeXAtLetter
  \catcode"FFFFF=9%"
  \setcatcoderange{"3000}{"65535}{13}}


\def\ltj@@listing@jpset@#1#2{{\lccode`\~=#1\lccode`\/=#1
    \lowercase{\gdef\@temp{\gdef~{#2/}}}}%
  \@temptokena\expandafter\expandafter\expandafter\expandafter%
  \expandafter\expandafter\expandafter{\expandafter\expandafter%
  \expandafter\the\expandafter\@temptokena\@temp}%
}

\def\ltj@@listing@jpset#1#2#3 {%
  \@tempcnta=#1 \@tempcntb=#2 \@temptokena{}
  \loop \advance\@tempcnta\@ne\ifnum\@tempcnta<\@tempcntb\relax
    \ltj@@listing@jpset@{\the\@tempcnta}#3\repeat
  \expandafter\edef\csname ltj@@listing@jpcmd@i#1\endcsname{\the\@temptokena}%
  \toks@\expandafter\expandafter\expandafter\expandafter%
  \expandafter\expandafter\expandafter{\expandafter\expandafter%
  \expandafter\the\expandafter\toks@\csname ltj@@listing@jpcmd@i#1\endcsname}
}

\input lltjp-listings-jpt.tex

\edef\ltj@@listing@jpcmd{\the\toks@}
\toks@{}
\lst@AddToHook{Init}{%
  \luatexcatcodetable\CatcodeTableLTJlistings
  \ltj@@listing@jpcmd}

\def\lst@ProcessJALetter{\lst@whitespacefalse \lst@AppendJALetter}
\def\lst@AppendJALetter{%
    \lst@ifletter \lst@Output\else\lst@OutputOther\fi\lst@lettertrue
    \advance\lst@length\@ne\lst@Append}
\def\lst@ProcessJALetterHalf{\lst@whitespacefalse \lst@AppendJALetterHalf}
\def\lst@AppendJALetterHalf{%
    \lst@ifletter \lst@Output\else\lst@OutputOther\fi\lst@lettertrue
    \lst@Append}


% 白線対策
\def\lst@OutputToken{%
    \lst@TrackNewLines \lst@OutputLostSpace
    \lst@ifgobbledws
        \lst@gobbledwhitespacefalse
        \lst@@discretionary
    \fi
    \lst@CheckMerge
    {\lst@thestyle{\lst@FontAdjust
     \setbox\@tempboxa\lst@hbox
        {\lsthk@OutputBox
         \lst@lefthss
         \expandafter\lst@FillOutputBox\the\lst@token\@empty
         \lst@righthss}%
     \ht\@tempboxa=0pt\dp\@tempboxa=0pt
     \lst@CalcLostSpaceAndOutput}}%
    \lst@ResetToken}


\endinput