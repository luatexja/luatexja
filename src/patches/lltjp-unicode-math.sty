%
% lltjp-unicode-math.sty
%

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{lltjp-unicode-math}[2013/05/14 Patch to unicode-math for LuaTeX-ja]

\RequirePackage{unicode-math,luatexja}

\ExplSyntaxOn

\group_begin:
  \cs_gset:Nn \um_define_math_chars: {
    \group_begin:
      \char_set_catcode_math_superscript:N \^
      \cs_set:Npn \_um_sym:nnn ##1##2##3 {
        \bool_if:nTF { \cs_if_eq_p:NN ##3 \mathaccent ||
                      \cs_if_eq_p:NN ##3 \mathopen   ||
                      \cs_if_eq_p:NN ##3 \mathclose  ||
                      \cs_if_eq_p:NN ##3 \mathover   ||
                      \cs_if_eq_p:NN ##3 \mathunder  ||
                      \cs_if_eq_p:NN ##3 \mathbotaccent } {
          \ltjsetmathletter{ ##1 }
        } {
          \um_cs_set_eq_active_char:Nw ##2 = ##1 \q_nil \ignorespaces
        }
      }
      \char_set_catcode_other:N \#
      \um_input_math_symbol_table:
    \group_end:
  }
  \cs_gset:Npn \um_cs_set_eq_active_char:Nw #1 = "#2 \q_nil {%"
    \group_begin:
      %\typeout {um: \string#1, \int_from_hexadecimal:n {#2}, #2}% <- for debug
      \char_set_lccode:nn { `! } { "#2 }%"
      \tex_lowercase:D {
        \tl_set:Nn \l_tmpa_tl {\relax\ifmmode!\else{\directlua{tex.globaldefs = 0}\ltj@allalchar!}\fi}
        \cs_gset_eq:NN #1 \l_tmpa_tl
      }
      \ltjsetmathletter{ \int_from_hexadecimal:n {#2} }
    \group_end:
  }
\group_end:

\ExplSyntaxOff

\endinput
