%
% ltj-latex.sty
%

%! これは外から読まれない
%% Avoid multiple loading.
\csname luatexjalatexLoaded\endcsname
\edef\ltj@latex@AtEnd{%
\endlinechar=\the\endlinechar
\relax}
\endlinechar\m@ne%
\def\luatexjalatexLoaded{\endinput}

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{ltj-latex}[2020-08-08 LaTeX support of LuaTeX-ja]

% cleanup at end of the document
%\let\ltj@@orig@end=\@@end
%\protected\def\@@end{%
%  \directlua{luatexja.ext_cleanup()}\ltj@@orig@end}

\endlinechar=13

%%% patch for LaTeX
\usepackage{lltjfont}
\usepackage{lltjdefs}
\usepackage{lltjcore}

%%% expl3
\RequirePackage{expl3}
\ExplSyntaxOn
% additions to l3box.dtx (pTeX/upTeX-specific)
\cs_set_eq:NN \platex_direction_yoko: \yoko
\cs_set_eq:NN \platex_direction_tate: \tate
\cs_set_eq:NN \platex_direction_dtou: \dtou
\prg_new_conditional:Npnn \platex_if_box_yoko:N #1 { p, T, F, TF }
  { \if_int_compare:w \ltjgetparameter{boxdir}{#1} = 4 \scan_stop:
      \prg_return_true: \else: \prg_return_false: \fi: }
\prg_new_conditional:Npnn \platex_if_box_tate:N #1 { p, T, F, TF }
  { \if_int_compare:w \ltjgetparameter{boxdir}{#1} = 3 \scan_stop:
      \prg_return_true:
    \else: \if_int_compare:w \ltjgetparameter{boxdir}{#1} = 11 \scan_stop: % utod
      \prg_return_true:
    \else
      \prg_return_false:
    \fi: \fi:}
\prg_new_conditional:Npnn \platex_if_box_dtou:N #1 { p, T, F, TF }
  { \if_int_compare:w \ltjgetparameter{boxdir}{#1} = 1 \scan_stop:
      \prg_return_true: \else: \prg_return_false: \fi: }
\prg_new_conditional:Npnn \platex_if_direction_yoko: { p, T, F, TF }
  { \if_int_compare:w \ltjgetparameter{direction} = 4 \scan_stop:
      \prg_return_true: \else: \prg_return_false: \fi: }
\prg_new_conditional:Npnn \platex_if_direction_tate: { p, T, F, TF }
  { \if_int_compare:w \ltjgetparameter{direction} = 3 \scan_stop:
      \prg_return_true:
    \else: \if_int_compare:w \ltjgetparameter{direction} = 11 \scan_stop: % utod
      \prg_return_true:
    \else
      \prg_return_false:
    \fi: \fi:}
\prg_new_conditional:Npnn \platex_if_direction_dtou: { p, T, F, TF }
  { \if_int_compare:w \ltjgetparameter{direction} = 1 \scan_stop:
      \prg_return_true: \else: \prg_return_false: \fi: }
\ExplSyntaxOff


%%% patching commands
\newif\ifltj@ltfilehook@avail
\@ifl@t@r\fmtversion{2020-10-01}{%
  \ifnum\patch@level<0\relax \ifnum\patch@level<-6 \ltj@ltfilehook@availtrue\fi
  \else\ltj@ltfilehook@availtrue\fi
}{}
\ifltj@ltfilehook@avail
  \def\@@ltj@ExecuteAfterPackage#1{\AddToHook{package/after/#1}}
  \def\@@ltj@ExecuteBeforePackage#1{\AddToHook{package/before/#1}}
  \def\ltj@ExecuteAfterPackage{\@ifstar\@@ltj@ExecuteAfterPackage@star\@@ltj@ExecuteAfterPackage}
  \def\@@ltj@ExecuteAfterPackage@star#1#2{%
    \@ifpackageloaded{#1}{#2}{\@@ltj@ExecuteAfterPackage{#1}{#2}}%
  }
  \def\ltj@ExecuteBeforePackage{\@ifstar\@@ltj@ExecuteBeforePackage@star\@@ltj@ExecuteBeforePackage}
  \def\@@ltj@ExecuteBeforePackage@star#1#2{%
    \@ifpackageloaded{#1}{#2}{\@@ltj@ExecuteBeforePackage{#1}{#2}}%
  }
\else
  \RequirePackage{filehook}
  \let\ltj@ExecuteAfterPackage=\AtEndOfPackageFile
  \let\ltj@ExecuteBeforePackage=\AtBeginOfPackageFile
\fi
\def\ltj@pkgpatch@im#1{\@ifnextchar[{\ltj@pkgpatch@im@{#1}}{\ltj@pkgpatch@im@{#1}[lltjp-#1]}}%]
\def\ltj@pkgpatch@im@#1[#2]{\ltj@ExecuteAfterPackage*{#1}{\ltj@pkgpatch@im@@{#2}}}
\def\ltj@pkgpatch@im@@#1{%
  \@ifpackageloaded{#1}{}{%
    \if\catcode`@=11\let\ltj@temp\relax\else
      \edef\ltj@temp{\noexpand\catcode`@=\the\catcode`@\relax}\makeatletter
    \fi
    \@@input{#1.\@pkgextension}\ltj@temp
  }%
}

\def\ltj@pkgpatch#1{\@ifnextchar[{\ltj@pkgpatch@{#1}}{\ltj@pkgpatch@{#1}[lltjp-#1]}}%]
\ifltj@ltfilehook@avail
  \def\ltj@pkgpatch@@{\AddToHook{env/document/before}[luatexja.autopatch]}
\else
  \def\ltj@pkgpatch@@{\gpreto\@begindocumenthook}
\fi
\def\ltj@pkgpatch@#1[#2]{%
  \ltj@pkgpatch@@{%
    \@ifpackageloaded{#1}{\@ifpackageloaded{#2}{}{\RequirePackage{#2}}}{}%
  }%
}
\expandafter\let\csname JY3/mc/m/n/10\endcsname\relax

%%% patch for packages
\ltj@pkgpatch@im{listings}
\ltj@pkgpatch{xunicode}  %% at \begin{document}
\ltj@pkgpatch@im{fontspec}
\ltj@pkgpatch{footmisc}  %% at \begin{document}
\ltj@pkgpatch{tascmac}
\ltj@pkgpatch{ascmac}[lltjp-tascmac]
\ltj@pkgpatch@im{stfloats}
\ltj@pkgpatch{preview}  %% at \begin{document}
  % (preview package has delayed option)
\ltj@pkgpatch{array}    %% at \begin{document}
\ltj@pkgpatch{collcell} %% at \begin{document}
\ltj@pkgpatch@im{unicode-math}
\ltj@pkgpatch@im{siunitx}
\ltj@pkgpatch@im{microtype}

\ifltj@ltshipout@avail\else\ltj@pkgpatch@im{everyshi}\fi

\RequirePackage{lltjp-geometry}

%%------------------ all done
\ltj@latex@AtEnd
\endinput
%% EOF
