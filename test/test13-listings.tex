%#!lualatex
\documentclass{article}

\usepackage{luatexja-fontspec}
\usepackage{listings,color,showexpl}
\usepackage
[
	papersize={100mm,100mm},
	hmargin={5mm,5mm},
	vmargin={5mm,5mm}
]{geometry}
\pagestyle{empty}

\lstset
{
	language=sh, extendedchars=false,
	backgroundcolor=\color[gray]{.75},
	breaklines=true,
    basewidth={0.55\zw, 0.45em},
	numbers=left,numberstyle=\tiny, numbersep=2pt,
}

\lstnewenvironment{env}[1]
{
	\ifx\relax#1\else
	\renewcommand{\lstlistingname}{ex}
	\lstset
	{
		caption=#1,
	}
	\fi
}{}
\DeclareFontShape{JY3}{mc}{m}{sl}{<-> s * [0.92489] psft:Ryumin-Light:jfm=ujis;slant=0.167}{}
\DeclareFontShape{JY3}{mc}{m}{it}{<-> ssub* mc/m/sl}{}

\setmainfont{TeX Gyre Pagella}
\setmonofont{TeX Gyre Cursor}
\begin{document}
This test file is based on a.tex\footnote{This can be downloaded from {\tt https://gist.github.com/1574793}.} by x19290.


\textbf{SOLVED}: bad folding and not slanted problems are common in pLaTeX and LuaTeX-ja.

The cause of the latter problem is that Japanese fonts don't have italic shape by default.
In this document, we define them by
\begin{lstlisting}[language={[AlLaTeX]TeX}, basicstyle=\ttfamily]
\DeclareFontShape{JY3}{mc}{m}{sl}{<-> s * [0.92489] psft:Ryumin-Light:jfm=ujis;slant=0.167}{}
\DeclareFontShape{JY3}{mc}{m}{it}{<-> ssub* mc/m/sl}{}
\end{lstlisting}
\newpage

We also avoid white band problem, by setting both the height and the depth of each 
letter/word to 0\,pt. 

\begin{env}{\relax}
#!/bin/sh
#長い長い長い長い長い長い長い長い長い長い長い長い長い長い長い長い
長い長い長い長い長い長い長い長い長い長い長い長い，長い長い長い長い長い長い
#I.長い長い長い長い長い長い長い長い長い長い長い長い長い長い長い長いI
長い長い長い長い長い長い長い長い長い長い長い長い長い長い長い長い
#IIII IIII IIII IIII IIII IIII IIII IIII IIII IIII IIII IIII IIII IIII IIII IIII
IIII IIII IIII IIII IIII IIII IIII IIII IIII IIII IIII IIII IIII IIII IIII IIII
\end{env}

Note that any \emph{kinsoku shori} is not performed inside \textsf{lstlisting} environment,
as the line~3 in output above. We leave it to further development.
\newpage

\textbf{SOLVED}: LuaTeX-ja specific problem:
when the \emph{begin} line of a listings environment ends with JAchar,
the first line of the listing is not rendered.

\begin{env}{problem; shebang not rendered --- 問題}
#!/bin/bash
:
\end{env}

\begin{LTXexample}[language=TeX]
え!1あ，い・あ）う（え
え!2あ
\end{LTXexample}

\lstinputlisting{test13-listings.tmp}

\begin{lstlisting}
え!1あｱｲｳｴｵ
え!2あ
\end{lstlisting}
\newpage
\textbf{Ticket \#29311}

\begin{env}{\relax}
長い長い長い長い長い長い長い長い長い長い長い長い＃い長い
長い長い長い長い長い長い長い長い長い長い長い長aaaa＃::い長い
長い長い長い長い長い長い長い長い長い長い長い長い，長い長い
長い長い長い長い長い長い長い長い長い長い長い長aa，::い長い
長い長い長い長い長い長い長い長い長い長い長い長，，::い長い
長い長い長い長い長い長い長い長い長い長い長い長（い長い
長い長い長い長い長い長い長い長い長い長い長いaa（い長い
長い長い長い長い長い長い長い長い長い長い長い長（aa長い
長い長い長い長い長い長い長い長い長い長い長い長い）（長い
\end{env}

\newpage
\textbf{Ticket \#29604}

\setmonofont{DejaVu Sans Mono}
\ltjsetparameter{jacharrange={-2,-3,-8}}
ギリシャ文字欧文扱い

\begin{lstlisting}[basewidth=.5em,basicstyle=\tt, emph={TeX}, emphstyle=\color{red}]
01234567890123456789
!あ!漢!α!×!
\TeX はギリシャ文字のΤ-Ε-Χ（タウ・イプシロン・カイ）であるから、……
\TeX is an abbreviation of τέχνη (ΤΕΧΝΗ – technē).
\end{lstlisting}

\ltjsetparameter{jacharrange={+2,+8,+3}}
ギリシャ文字和文扱い

\begin{lstlisting}[basewidth=.5em,basicstyle=\tt, emph={TeX}, emphstyle=\color{red}]
01234567890123456789
!あ!漢!α!×!
\TeX はギリシャ文字のΤ-Ε-Χ（タウ・イプシロン・カイ）であるから、……
\TeX is an abbreviation of τέχνη (ΤΕΧΝΗ – technē).
\end{lstlisting}
\end{document}
